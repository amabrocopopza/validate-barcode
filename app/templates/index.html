<!-- app/templates/index.html -->

<!DOCTYPE html>
<html>

<head>
    <title>Inventory Validation</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

</head>

<body>
    <!-- Loading Spinner -->
    <div class="spinner-overlay" id="spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <div class="container">
        <h1 class="text-center">Product Validation</h1>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Search Section -->
        <div class="search-section mt-3">
            <form id="search-form" class="form-inline justify-content-center" onsubmit="performSearch(event)">
                <div class="form-group mb-2">
                    <label for="search-term" class="sr-only">Search Product</label>
                    <input type="text" class="form-control" id="search-term" placeholder="Enter product name"
                        value="{{ product['product_name'] if product else '' }}" required>
                </div>
                <button type="submit" class="btn btn-primary mb-2 ml-2">Search</button>
            </form>
        </div>

        <!-- Suggestions Dropdown -->
        <div class="suggestions-section mt-3">
            <label for="suggestions-dropdown">Select a Product:</label>
            <select class="form-control" id="suggestions-dropdown" onchange="displaySelectedProduct()">
                <option value="">-- Select a Product --</option>
                {% if initial_suggestions %}
                {% for p in initial_suggestions %}
                <option value="{{ p.code }}">
                    {{ p.name }} - {{ p.price }}
                </option>
                {% endfor %}
                {% endif %}
            </select>
        </div>

        <!-- Display Selected Product Details -->
        <div class="selected-product-section mt-4" style="display: none;">
            <div class="product-details">
                <table class="table table-bordered">
                    <tbody>
                        <tr>
                            <th>Product Name</th>
                            <td id="selected-product-name"></td>
                        </tr>
                        <tr>
                            <th>Price</th>
                            <td id="price-display">R0.00</td>
                        </tr>
                        <tr>
                            <th>Difference from Retail Price</th>
                            <td id="price-difference"></td>
                        </tr>
                        <tr>
                            <th>Barcode</th>
                            <td id="barcode-display">Fetching...</td>
                        </tr>
                        <tr>
                            <th>Description</th>
                            <td id="description-display">No description available.</td>
                        </tr>
                        <tr>
                            <th>Brand</th>
                            <td id="brand-display">N/A</td>
                        </tr>
                        <tr>
                            <th>Brand Seller ID</th>
                            <td id="brand-seller-id-display">N/A</td>
                        </tr>
                        <tr>
                            <th>Default Unit of Measure</th>
                            <td id="unit-of-measure-display">N/A</td>
                        </tr>
                        <tr>
                            <th>Images</th>
                            <td id="image-carousel">
                                <!-- Carousel will be injected here -->
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons text-center">
                <!-- Yes, No, Skip Buttons -->
                <form method="post" id="action-form" onsubmit="showSpinner()">
                    <input type="hidden" name="sku" id="action-sku" value="">
                    <button type="submit" name="action" value="yes" class="btn btn-success">Yes</button>
                    <button type="submit" name="action" value="no" class="btn btn-danger">No</button>
                    <button type="submit" name="action" value="skip" class="btn btn-secondary">Skip</button>
                </form>
            </div>
        </div>

        <!-- Main Product Table -->
        <div class="main-product-table-section mt-5">
            <h3>Main Product Information</h3>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Product Name</th>
                        <th>Description</th>
                        <th>Retail Price</th>
                        <th>Brand</th>
                        <th>Product Category</th>
                        <th>Supplier Name</th>
                        <!-- Add more headers as needed -->
                    </tr>
                </thead>
                <tbody>
                    {% if main_inventory %}
                    {% for item in main_inventory %}
                    <tr id="main-product-{{ item.sku }}">
                        <td>{{ item.sku }}</td>
                        <td>{{ item.product_name }}</td>
                        <td>{{ item.description or 'No description available.' }}</td>
                        <td>{{ 'R' + '%.2f' | format(item.retail_price) }}</td>
                        <td>{{ item.brand_name or 'N/A' }}</td>
                        <td>{{ item.product_category or 'N/A' }}</td>
                        <td>{{ item.supplier_name or 'N/A' }}</td>
                        <!-- Add more cells as needed -->
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center">No products available.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if not product %}
        <div class="alert alert-info" role="alert">
            {{ message }}
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

    <!-- JavaScript to Handle Spinner and AJAX -->
    <script>
        function showSpinner() {
            document.getElementById('spinner').style.display = 'flex';
        }

        function hideSpinner() {
            document.getElementById('spinner').style.display = 'none';
        }

        // Perform Search Function
        function performSearch(event) {
            if (event) {
                event.preventDefault();
            }
            const searchTerm = $('#search-term').val().trim();
            if (searchTerm === '') {
                alert('Please enter a product name to search.');
                return;
            }

            showSpinner();

            $.ajax({
                url: "{{ url_for('pnp.search') }}",
                method: 'POST',
                data: { 'search_term': searchTerm },
                success: function (response) {
                    hideSpinner();
                    if (response.success) {
                        populateSuggestions(response.products);
                    } else {
                        alert(response.message || 'No suggestions found.');
                        $('.suggestions-section').hide();
                        $('.selected-product-section').hide();
                    }
                },
                error: function () {
                    hideSpinner();
                    alert('An error occurred while fetching suggestions.');
                }
            });
        }

        // Populate Suggestions Dropdown
        function populateSuggestions(products) {
            const dropdown = $('#suggestions-dropdown');
            dropdown.empty();
            dropdown.append('<option value="">-- Select a Product --</option>');
            products.forEach(product => {
                const option = `
                    <option value="${product.code}">
                        ${escapeHtml(product.name)} - ${escapeHtml(product.price)}
                    </option>
                `;
                dropdown.append(option);
            });
            $('.suggestions-section').show();
            $('.selected-product-section').hide();
        }

        // Display Selected Product Details
        function displaySelectedProduct() {
            const selectedOption = $('#suggestions-dropdown').find(':selected');
            const sku = selectedOption.val();
            if (sku === '') {
                $('.selected-product-section').hide();
                return;
            }

            // Set the SKU in the hidden input field
            $('#action-sku').val(sku);

            // Show spinner while fetching barcode and details
            showSpinner();

            // Fetch barcode and other details via AJAX
            $.ajax({
                url: "{{ url_for('pnp.fetch_barcode') }}",
                method: 'POST',
                data: { 'product_code': sku },
                success: function (response) {
                    hideSpinner();
                    if (response.success) {
                        // Update fields with response data
                        $('#selected-product-name').text(response.product_name || 'N/A');
                        $('#price-display').text(response.price_formatted || 'R0.00');

                        // Retrieve retail_price from the main product table
                        const mainProductRow = $(`#main-product-${sku}`);
                        const retailPriceText = mainProductRow.find('td').eq(3).text(); // 4th column is retail_price
                        const retailPrice = parseFloat(retailPriceText.replace('R', '')) || 0;

                        // priceValue from AJAX response
                        const priceValue = parseFloat(response.price_value) || 0;
                        const difference = priceValue - retailPrice;

                        if (difference < 0) {
                            $('#price-difference').html(`<span class="difference-negative">-${formatCurrency(Math.abs(difference))}</span>`);
                        } else if (difference > 0) {
                            $('#price-difference').html(`<span class="difference-positive">+${formatCurrency(difference)}</span>`);
                        } else {
                            $('#price-difference').text('R0.00');
                        }

                        $('#barcode-display').text(response.barcode || 'N/A');
                        $('#description-display').text(response.description || 'No description available.');
                        $('#brand-display').text(response.brand || 'N/A');
                        $('#brand-seller-id-display').text(response.brandSellerId || 'N/A');
                        $('#unit-of-measure-display').text(response.defaultUnitOfMeasure || 'N/A');

                        // Handle Images Carousel
                        if (response.imageUrls && response.imageUrls.length > 0) {
                            let carouselItems = '';
                            response.imageUrls.forEach((url, index) => {
                                carouselItems += `
                                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                        <img src="${escapeHtml(url)}" class="d-block w-100" alt="Product Image">
                                    </div>
                                `;
                            });

                            const carouselHtml = `
                                <div id="productImagesCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
                                    <div class="carousel-inner">
                                        ${carouselItems}
                                    </div>
                                    <a class="carousel-control-prev" href="#productImagesCarousel" role="button" data-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="sr-only">Previous</span>
                                    </a>
                                    <a class="carousel-control-next" href="#productImagesCarousel" role="button" data-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="sr-only">Next</span>
                                    </a>
                                </div>
                            `;
                            $('#image-carousel').html(carouselHtml);
                        } else {
                            $('#image-carousel').text('No image available.');
                        }

                        $('.selected-product-section').show();
                    } else {
                        // If fetching details failed, show error and hide details section
                        alert(response.message || 'Failed to fetch product details.');
                        $('.selected-product-section').hide();
                    }
                },
                error: function () {
                    hideSpinner();
                    alert('An error occurred while fetching product details.');
                    $('.selected-product-section').hide();
                }
            });
        }

        // Function to format currency
        function formatCurrency(amount) {
            return 'R' + amount.toFixed(2);
        }

        // Utility function to escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Perform an initial search on page load
        $(document).ready(function () {
            const initialSearchTerm = "{{ product['product_name'] if product else '' }}";
            if (initialSearchTerm) {
                $('#search-term').val(initialSearchTerm);
                performSearch();  // Call without event
            }

            // Attach event listener to the suggestions dropdown
            $('#suggestions-dropdown').change(function () {
                displaySelectedProduct();
            });
        });
    </script>
</body>

</html>